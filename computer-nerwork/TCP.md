**前言：本篇记录下 TCP 相关的知识**

### 一、什么是 TCP
> TCP 是面向连接的、可靠的、基于字节流的传输层通信协议。
### 二、三次握手和四次挥手
1. **三次握手**
  * 客户端和服务端之间的通信是通过发送报文来完成的；当要进行连接通信时，首先客户端会先发送一个 SYN 报文(报文中的 SYN 标志位置为 1)到服务端，同时带有一个序列号 seq1，表明想要跟服务端进行连接通信；
  * 服务端收到这个 SYN 报文之后，同意进行连接的话，会发送三次握手中的第二个报文 SYN+ACK (SYN 和 ACK 标志位置 1)报文，表明服务端收到了客户端发送的SYN报文；同时服务端发送的报文会带上一个序列号 seq2 和一个确认应答号(第一个报文的序列号+1，即 seq1 + 1)；
  * 客户端收到服务端发送的报文之后，会发送一个 ACK 报文，表明收到服务端的应答；这个应答报文会带有一个确认应答号，为服务端发送报文的序列号 +1(即 seq2 + 1)；此时的报文可以携带数据；客户端处于 ESTABLISHED
  * 服务端收到之后，就进入连接已建立状态，ESTABLISHED
    > SYN：同步序列编号（Synchronize Sequence Numbers）为1时，表示希望建立连接    
    > 三次握手中，前两次握手的报文是不能携带数据的，第三次握手的报文可以携带数据

2. **四次挥手**
  * 首先客户端和服务端都能主动发起关闭连接；
  * 假设客户端数据传输完成，发起连接的关闭，会发送一个FIN报文，即FIN标志位置为1的报文；进入FIN_WAIT_1 状态；
  * 服务端收到后会发送一个应答报文；
  * 客户端收到应答报文后，会进入FIN_WAIT_2 状态；在 FIN_WAIT_2 状态中，如果服务端有未完成的任务，未传输完成的数据，可以继续传输，客户端也继续接受；等到服务端也将数据传输完成后，会发送一个FIN报文，服务端进入LAST_ACK 状态；
  * 客户端收到FIN报文后，发送一个ACK报文，此时进入TIME_WAIT 状态；
  * 服务端收到ACK报文后，就进入CLOSE状态，服务端连接关闭；
  * 客户端经过 2MSL 一段时间后，进入CLOSE状态，也关闭连接
    > FIN报文：finish   
    关闭连接时，客户端向服务端发送 FIN 时，仅仅表示客户端不再发送数据了但是还能接收数据。   
    服务端收到客户端的 FIN 报文时，先回一个 ACK 应答报文，而服务端可能还有数据需要处理和发送，等服务端不再发送数据时，才发送 FIN 报文给客户端来表示同意现在关闭连接。服务端通常需要等待完成数据的发送和处理，所以服务端的 ACK 和 FIN 一般都会分开发送，因此是需要四次挥手
### 三、TCP 粘包问题
1. **什么是 TCP 粘包**
  * 首先，TCP 是传输控制协议，是一种面向连接、可靠的、基于字节流的传输层通信协议；因为是基于字节流传输，所以传输时数据与数据之间是没有边界的，所以就会导致数据粘连一起。
  * 由于 TCP 是面向连接且可靠的，所以传输的数据必须保证完整，TCP 建立连接会在发送端和接收端都建立缓冲区；当接收端在接受的时候，如果接受不及时，数据源源不断到来，那么会使得多段数据粘连一起；
  * Nagle 算法引起粘包；为了避免传输数据时的拥塞，也就是某一段传输的数据很小，也包装上 IP 首部、TCP 首部，就非常的浪费。所以 Nagle 算法就划定了一个规则，将多个小数据合成一个较为适合大小的数据段，然后再发送；
2. **如何解决粘包**
  * 使用特定字符作为边界判定；可以在两个消息之间插入指定的特殊字符，当读到这个特殊字符时，就表示一个消息已经读完；比如 HTTP，通过设置回车符、换行符作为 HTTP header 头部报文协议的边界。
  * 固定传输消息的字符长度，当读到指定的消息长度后，就表示是一个完整的消息。但这种方式不灵活，也少用；HTTP 通过 Content-length 字段作为 HTTP bodt 的边界
### 四、OSI七层网络参考模型和TCP/IP五层模型

#### 1、OSI七层网络参考模型
* 分别是：1. 应用层、表示层、会话层、传输层、网络层、数据链路层、物理层
#### 2、TCP/IP五层模型
* 分别是：应用层、传输层、网络层、数据链路层、物理层
* 也有说是四层，将最后两层合成一层，也就是：应用层、传输层、网络层、数据链路层
  > * 应用层用到的协议：HTTP
  > * 传输层使用的协议有：TCP、UDP
  > * 传输层实际做的事是为应用层提供服务，作为应用间传输数据的媒介，帮助实现从应用到应用的通信
  > * 网络层使用的协议：IP